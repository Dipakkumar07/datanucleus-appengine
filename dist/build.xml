<?xml version="1.0" encoding="ISO-8859-1"?>
<project name="gae" default="dist">

  <property name="version.major" value="0"/>
  <property name="version.minor" value="3"/>
  <property name="version" value="${version.major}.${version.minor}"/>
  <property name="orm.source.zip" value="datanucleus-appengine-${version}-src.zip"/>
  <property name="orm.jar" value="datanucleus-appengine-${version}.jar"/>
  <property name="dist.target" value="appengine-orm-${version}.zip"/>
  <target name="dist" depends="split" description="Build the datanucleus appengine distribution">
    <zip destfile="${orm.source.zip}">
      <fileset dir="../src" includes="**/*"/>
    </zip>
    <copy file="../datanucleus-appengine-SNAPSHOT.jar" tofile="datanucleus-appengine-${version}.jar"/>
    <copy file="../lib/external-api.jar" todir="../demos/lib"/>
    <copy file="../lib/external-dev-appserver.jar" todir="../demos/lib"/>
    <zip destfile="${dist.target}">
      <fileset dir="../lib">
        <include name="asm-3.1.jar"/>
        <include name="jdo2-api-2.2.jar"/>
        <include name="jta.jar"/>
        <include name="persistence-api-1.0.2.jar"/>
        <include name="datanucleus-enhancer*"/>
        <include name="datanucleus-jpa*"/>
        <include name="datanucleus-rdbms-*src*"/>
        <include name="datanucleus-core-*src*"/>
      </fileset>
      <fileset dir="../lib/split">
        <include name="*.jar"/>
      </fileset>
      <fileset file="${orm.jar}"/>
      <fileset file="${orm.source.zip}"/>
      <fileset file="README"/>
      <fileset dir="..">
        <include name="demos/**"/>
        <include name="doc/**"/>
      </fileset>
    </zip>
    <delete dir="../lib/split"/>
    <delete file="${orm.jar}"/>
    <delete file="${orm.source.zip}"/>
    <delete file="../demos/lib/external-api.jar"/>
    <delete file="../demos/lib/external-dev-appserver.jar"/>
  </target>

  <target name="split" description="Split the datanucleus jars into chunks smaller than 1MB.
                                    Typically we would let the appcfg script do this for us,
                                    but because of some special requirements that datanucleus
                                    has we need to do this ourselves.">
    <mkdir dir="../lib/split"/>
    <java dir="../lib" fork="true" classname="com.google.apphosting.tools.JarSplitter" classpath="../lib/JarSplitter_deploy.jar">
      <arg value="--input_jar=datanucleus-core-1.1.0.m1.jar"/>
      <arg value="--output_directory=split"/>
      <arg value="--max_file_size=1000000"/>
      <arg value="--replicate_manifests=true"/>
    </java>
    <java dir="../lib" fork="true" classname="com.google.apphosting.tools.JarSplitter" classpath="../lib/JarSplitter_deploy.jar">
      <arg value="--input_jar=datanucleus-rdbms-1.1.0.m1.jar"/>
      <arg value="--output_directory=split"/>
      <arg value="--max_file_size=1000000"/>
      <arg value="--replicate_manifests=true"/>
    </java>
  </target>

  <property name="tmp.dir" value="/tmp/testdist"/>

  <target name="testdist" description="Unzip the dist, launch one of the sample apps, and hit it
                                       with curl to make sure it is functioning properly.">
    <delete dir="${tmp.dir}"/>
    <mkdir dir="${tmp.dir}"/>
    <unzip src="${dist.target}" dest="${tmp.dir}"/>
    <parallel>
      <daemons>
        <exec executable="ant" dir="${tmp.dir}/demos/helloorm"/>
      </daemons>
      <sequential>
        <sleep seconds="5"/>

        <!-- create a flight -->
        <exec executable="curl" failifexecutionfails="true" failonerror="true">
          <arg value="-d"/>
          <arg value="orig=BOS&amp;dest=LAX"/>
          <arg value="http://localhost:8080/addFlight"/>
        </exec>
        <exec executable="curl" failifexecutionfails="true" failonerror="true" outputproperty="curl.add.result">
          <arg value="http://localhost:8080"/>
        </exec>
        <condition property="expected.add.response">
          <contains string="${curl.add.result}" substring="agU6c2VsZnIMCxIGRkxJR0hUGAEM"/>
        </condition>
        <fail unless="expected.add.response" message="Did not get the expected add response: ${curl.add.result}${line.separator}${line.separator}    BUILD FAILED!!!!"/>

         <!-- issue a jpql query -->
        <exec executable="curl" failifexecutionfails="true" failonerror="true" outputproperty="curl.query.result">
          <arg value="-d"/>
          <arg value="q=select f from com.google.appengine.helloorm.Flight f where orig = 'BOS'"/>
          <arg value="http://localhost:8080"/>
        </exec>
        <condition property="expected.query.response">
          <contains string="${curl.query.result}" substring="agU6c2VsZnIMCxIGRkxJR0hUGAEM"/>
        </condition>
        <fail unless="expected.query.response" message="Did not get the expected query response: ${curl.query.result}${line.separator}${line.separator}    BUILD FAILED!!!!"/>

        <!-- switch to jdo -->
       <exec executable="curl" failifexecutionfails="true" failonerror="true">
         <arg value="-d"/>
         <arg value="persistenceStandard=JDO"/>
         <arg value="http://localhost:8080/updatePersistenceStandard"/>
       </exec>
        <exec executable="curl" failifexecutionfails="true" failonerror="true" outputproperty="curl.switchps.result">
          <arg value="http://localhost:8080"/>
        </exec>
       <condition property="expected.switchps.response">
         <contains string="${curl.switchps.result}" substring="Persistence standard is JDO"/>
       </condition>
       <fail unless="expected.switchps.response" message="Did not get the expected switchps response: ${curl.switchps.result}${line.separator}${line.separator}    BUILD FAILED!!!!"/>
      </sequential>
    </parallel>
  </target>
</project>